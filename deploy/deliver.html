<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Deliver Bed - Goods Tracker</title>

  <!-- PWA Support -->
  <meta name="theme-color" content="#1d4ed8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f172a;
      min-height: 100vh;
      color: white;
    }

    .app {
      max-width: 500px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Hamburger Menu */
    .hamburger-nav {
      background: #1e293b;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #334155;
    }

    .hamburger-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      line-height: 1;
    }

    .nav-title-small {
      font-size: 14px;
      color: #94a3b8;
    }

    .offline-indicator {
      background: #f59e0b;
      color: #000;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      display: none;
    }

    .offline-indicator.show {
      display: block;
    }

    /* Slide-out Menu */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 500;
      display: none;
    }

    .menu-overlay.show {
      display: block;
    }

    .slide-menu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: #1e293b;
      z-index: 501;
      transition: left 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .slide-menu.show {
      left: 0;
    }

    .menu-header {
      padding: 20px;
      border-bottom: 1px solid #334155;
    }

    .menu-header h2 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .menu-header p {
      font-size: 12px;
      color: #94a3b8;
    }

    .menu-items {
      flex: 1;
      padding: 16px 0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      color: white;
      text-decoration: none;
      font-size: 15px;
      transition: background 0.2s;
    }

    .menu-item:hover {
      background: #334155;
    }

    .menu-item.active {
      background: #3b82f6;
    }

    .menu-item-icon {
      font-size: 20px;
      width: 28px;
      text-align: center;
    }

    .menu-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 24px;
      cursor: pointer;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      padding: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .header p {
      font-size: 13px;
      opacity: 0.9;
      margin-top: 4px;
    }

    /* Search Section */
    .search-section {
      padding: 16px;
      background: #1e293b;
    }

    .search-box {
      display: flex;
      gap: 8px;
    }

    .search-input {
      flex: 1;
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid #334155;
      border-radius: 10px;
      background: #0f172a;
      color: white;
      text-transform: uppercase;
    }

    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .search-input::placeholder {
      color: #64748b;
      text-transform: none;
    }

    .scan-btn {
      padding: 14px 20px;
      background: #3b82f6;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 18px;
      cursor: pointer;
      font-weight: 600;
    }

    .scan-btn:active {
      transform: scale(0.95);
    }

    /* QR Scanner Modal - Using native camera input */
    .scanner-section {
      background: #1e293b;
      margin: 16px;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      display: none;
    }

    .scanner-section.show {
      display: block;
    }

    .scanner-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .scanner-preview {
      background: #0f172a;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .scanner-preview video {
      width: 100%;
      max-width: 300px;
      border-radius: 8px;
    }

    .scanner-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .scanner-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .scanner-btn.primary {
      background: #3b82f6;
      color: white;
    }

    .scanner-btn.secondary {
      background: #334155;
      color: white;
    }

    /* Asset Card */
    .asset-card {
      background: #1e293b;
      margin: 16px;
      border-radius: 16px;
      overflow: hidden;
      display: none;
    }

    .asset-card.show {
      display: block;
    }

    .asset-header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .asset-id {
      font-size: 24px;
      font-weight: 700;
    }

    .asset-type {
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .asset-details {
      padding: 20px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #334155;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      color: #94a3b8;
      font-size: 13px;
    }

    .detail-value {
      color: white;
      font-size: 14px;
      font-weight: 500;
      text-align: right;
      max-width: 60%;
    }

    /* Delivery Form */
    .delivery-form {
      padding: 16px;
      display: none;
    }

    .delivery-form.show {
      display: block;
    }

    .form-section {
      background: #1e293b;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Photo Capture */
    .photo-capture {
      background: #0f172a;
      border: 2px dashed #334155;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .photo-capture:hover {
      border-color: #3b82f6;
      background: #1e293b;
    }

    .photo-capture.has-photo {
      padding: 0;
      border-style: solid;
      border-color: #10b981;
    }

    .photo-capture img {
      width: 100%;
      border-radius: 10px;
      display: block;
    }

    .photo-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .photo-text {
      color: #94a3b8;
      font-size: 14px;
    }

    .photo-text strong {
      color: white;
      display: block;
      margin-bottom: 4px;
    }

    #photoInput {
      display: none;
    }

    .photo-size {
      font-size: 11px;
      color: #64748b;
      margin-top: 8px;
    }

    /* Location */
    .location-box {
      background: #0f172a;
      border-radius: 12px;
      padding: 16px;
    }

    .location-status {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .location-icon {
      width: 40px;
      height: 40px;
      background: #334155;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .location-icon.success {
      background: #10b981;
    }

    .location-icon.loading {
      background: #f59e0b;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .location-info {
      flex: 1;
    }

    .location-label {
      font-size: 13px;
      color: #94a3b8;
    }

    .location-value {
      font-size: 14px;
      font-weight: 500;
      margin-top: 2px;
    }

    .location-btn {
      width: 100%;
      padding: 12px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .location-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Notes */
    .notes-input {
      width: 100%;
      padding: 14px;
      background: #0f172a;
      border: 2px solid #334155;
      border-radius: 10px;
      color: white;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }

    .notes-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .notes-input::placeholder {
      color: #64748b;
    }

    /* Recipient */
    .recipient-input {
      width: 100%;
      padding: 14px;
      background: #0f172a;
      border: 2px solid #334155;
      border-radius: 10px;
      color: white;
      font-size: 16px;
      margin-bottom: 12px;
    }

    .recipient-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    /* Submit Button */
    .submit-section {
      padding: 16px;
      padding-bottom: 32px;
      display: none;
    }

    .submit-section.show {
      display: block;
    }

    .submit-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.2s;
    }

    .submit-btn:hover:not(:disabled) {
      transform: scale(1.02);
    }

    .submit-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Success Screen */
    .success-screen {
      position: fixed;
      inset: 0;
      background: #0f172a;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      z-index: 200;
    }

    .success-screen.show {
      display: flex;
    }

    .success-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
      margin-bottom: 24px;
      animation: scaleIn 0.5s ease-out;
    }

    @keyframes scaleIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .success-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .success-subtitle {
      color: #94a3b8;
      font-size: 16px;
      text-align: center;
      margin-bottom: 32px;
    }

    .success-details {
      background: #1e293b;
      border-radius: 16px;
      padding: 20px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 32px;
    }

    .success-detail {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
    }

    .success-detail-label {
      color: #94a3b8;
    }

    .success-detail-value {
      font-weight: 600;
    }

    .next-btn {
      width: 100%;
      max-width: 300px;
      padding: 16px;
      background: #3b82f6;
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Message */
    .message {
      position: fixed;
      top: 80px;
      left: 16px;
      right: 16px;
      max-width: 468px;
      margin: 0 auto;
      padding: 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      z-index: 150;
      display: none;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .message.show {
      display: block;
    }

    .message.error {
      background: #ef4444;
    }

    .message.info {
      background: #3b82f6;
    }

    .message.success {
      background: #10b981;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-content {
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #334155;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Recent deliveries */
    .recent-section {
      padding: 16px;
    }

    .recent-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #94a3b8;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .recent-count {
      background: #3b82f6;
      color: white;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 13px;
    }

    .recent-item {
      background: #1e293b;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .recent-check {
      width: 32px;
      height: 32px;
      background: #10b981;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .recent-info {
      flex: 1;
    }

    .recent-id {
      font-weight: 600;
      font-size: 14px;
    }

    .recent-time {
      font-size: 12px;
      color: #64748b;
    }

    .recent-pending {
      background: #f59e0b;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-text {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Hamburger Navigation -->
    <div class="hamburger-nav">
      <button class="hamburger-btn" id="menuBtn">&#9776;</button>
      <span class="nav-title-small">Goods Asset Tracker</span>
      <div id="offlineBadge" class="offline-indicator">OFFLINE</div>
    </div>

    <!-- Slide-out Menu -->
    <div class="menu-overlay" id="menuOverlay"></div>
    <div class="slide-menu" id="slideMenu">
      <button class="menu-close" id="menuClose">&times;</button>
      <div class="menu-header">
        <h2>Goods Asset Tracker</h2>
        <p>Asset Management System</p>
      </div>
      <div class="menu-items">
        <a href="dashboard.html" class="menu-item">
          <span class="menu-item-icon">üìä</span>
          Dashboard
        </a>
        <a href="deliver.html" class="menu-item active">
          <span class="menu-item-icon">üöö</span>
          Deliver Bed
        </a>
        <a href="products.html" class="menu-item">
          <span class="menu-item-icon">üì¶</span>
          Products
        </a>
        <a href="index.html" class="menu-item">
          <span class="menu-item-icon">üé´</span>
          Support Ticket
        </a>
      </div>
    </div>

    <div class="header">
      <h1>Deliver Bed</h1>
      <p>Scan QR or enter asset ID</p>
    </div>

    <div class="search-section">
      <div class="search-box">
        <input type="text" id="assetSearch" class="search-input" placeholder="Enter Asset ID (e.g. GB0-152-1)" autocomplete="off">
        <button class="scan-btn" id="scanBtn" title="Scan QR Code">üì∑</button>
      </div>
    </div>

    <!-- QR Scanner Section (inline, not modal) -->
    <div id="scannerSection" class="scanner-section">
      <div class="scanner-title">Scan QR Code</div>
      <div class="scanner-preview">
        <div id="qr-reader" style="width: 100%;"></div>
      </div>
      <div class="scanner-actions">
        <button class="scanner-btn secondary" id="stopScanBtn">Cancel</button>
      </div>
    </div>

    <div id="messageBox" class="message"></div>

    <div id="assetCard" class="asset-card">
      <div class="asset-header">
        <span id="assetIdDisplay" class="asset-id">GB0-152-1</span>
        <span id="assetTypeDisplay" class="asset-type">Basket Bed</span>
      </div>
      <div class="asset-details">
        <div class="detail-row">
          <span class="detail-label">Recipient</span>
          <span id="recipientDisplay" class="detail-value">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Community</span>
          <span id="communityDisplay" class="detail-value">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Address</span>
          <span id="placeDisplay" class="detail-value">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span id="statusDisplay" class="detail-value">Not Delivered</span>
        </div>
      </div>
    </div>

    <div id="deliveryForm" class="delivery-form">
      <div class="form-section">
        <div class="section-title">üì∏ Photo of Delivery</div>
        <div class="photo-capture" id="photoCapture">
          <div id="photoPlaceholder">
            <div class="photo-icon">üì∑</div>
            <div class="photo-text">
              <strong>Take a Photo</strong>
              Show the bed at delivery location
            </div>
          </div>
          <img id="photoPreview" style="display: none;">
        </div>
        <div id="photoSize" class="photo-size"></div>
        <input type="file" id="photoInput" accept="image/*" capture="environment">
      </div>

      <div class="form-section">
        <div class="section-title">üìç GPS Location</div>
        <div class="location-box">
          <div class="location-status">
            <div id="locationIcon" class="location-icon">üìç</div>
            <div class="location-info">
              <div class="location-label">Coordinates</div>
              <div id="locationValue" class="location-value">Getting location...</div>
            </div>
          </div>
          <button id="locationBtn" class="location-btn" style="display: none;">Refresh Location</button>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üë§ Recipient Name (Optional)</div>
        <input type="text" id="recipientInput" class="recipient-input" placeholder="Name of person receiving the bed">
      </div>

      <div class="form-section">
        <div class="section-title">üìù Delivery Notes (Optional)</div>
        <textarea id="notesInput" class="notes-input" placeholder="Any notes about this delivery..."></textarea>
      </div>
    </div>

    <div id="submitSection" class="submit-section">
      <button id="submitBtn" class="submit-btn">
        ‚úì Confirm Delivery
      </button>
    </div>

    <div class="recent-section">
      <div class="recent-title">
        Today's Deliveries
        <span id="deliveryCount" class="recent-count">0</span>
      </div>
      <div id="recentDeliveries">
        <div class="empty-state">
          <div class="empty-icon">üì¶</div>
          <div class="empty-text">No deliveries yet today</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Screen -->
  <div id="successScreen" class="success-screen">
    <div class="success-icon">‚úì</div>
    <div class="success-title">Delivered!</div>
    <div class="success-subtitle">Asset has been marked as delivered with photo and location</div>
    <div class="success-details">
      <div class="success-detail">
        <span class="success-detail-label">Asset ID</span>
        <span id="successAssetId" class="success-detail-value">-</span>
      </div>
      <div class="success-detail">
        <span class="success-detail-label">Time</span>
        <span id="successTime" class="success-detail-value">-</span>
      </div>
      <div class="success-detail">
        <span class="success-detail-label">Location</span>
        <span id="successLocation" class="success-detail-value">Captured</span>
      </div>
    </div>
    <button id="nextBtn" class="next-btn">üì¶ Deliver Next Bed</button>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div id="loadingText">Saving delivery...</div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- QR Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const SUPABASE_URL = 'https://cwsyhpiuepvdjtxaozwf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3c3locGl1ZXB2ZGp0eGFvendmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NTcxODgsImV4cCI6MjA4MDIzMzE4OH0.Pgexh-ff_zU4SsDWV3uGO7foQjCO8xZbWvN_BU6Vxkw';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================================================
    // STATE
    // ============================================================================
    let currentAsset = null;
    let capturedPhoto = null;
    let compressedPhotoBlob = null;
    let capturedLocation = null;
    let todayDeliveries = [];
    let pendingDeliveries = []; // For offline mode
    let html5QrCode = null;
    let isOnline = navigator.onLine;

    // ============================================================================
    // DOM ELEMENTS
    // ============================================================================
    const assetSearch = document.getElementById('assetSearch');
    const assetCard = document.getElementById('assetCard');
    const deliveryForm = document.getElementById('deliveryForm');
    const submitSection = document.getElementById('submitSection');
    const photoCapture = document.getElementById('photoCapture');
    const photoInput = document.getElementById('photoInput');
    const photoPreview = document.getElementById('photoPreview');
    const photoPlaceholder = document.getElementById('photoPlaceholder');
    const photoSize = document.getElementById('photoSize');
    const locationBtn = document.getElementById('locationBtn');
    const locationIcon = document.getElementById('locationIcon');
    const locationValue = document.getElementById('locationValue');
    const submitBtn = document.getElementById('submitBtn');
    const successScreen = document.getElementById('successScreen');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const messageBox = document.getElementById('messageBox');
    const scannerSection = document.getElementById('scannerSection');
    const offlineBadge = document.getElementById('offlineBadge');

    // Menu elements
    const menuBtn = document.getElementById('menuBtn');
    const menuClose = document.getElementById('menuClose');
    const menuOverlay = document.getElementById('menuOverlay');
    const slideMenu = document.getElementById('slideMenu');

    // ============================================================================
    // HAMBURGER MENU
    // ============================================================================

    menuBtn.addEventListener('click', () => {
      slideMenu.classList.add('show');
      menuOverlay.classList.add('show');
    });

    menuClose.addEventListener('click', closeMenu);
    menuOverlay.addEventListener('click', closeMenu);

    function closeMenu() {
      slideMenu.classList.remove('show');
      menuOverlay.classList.remove('show');
    }

    // ============================================================================
    // OFFLINE SUPPORT
    // ============================================================================

    window.addEventListener('online', () => {
      isOnline = true;
      offlineBadge.classList.remove('show');
      showMessage('Back online! Syncing...', 'success');
      syncPendingDeliveries();
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      offlineBadge.classList.add('show');
      showMessage('You are offline. Deliveries will sync when connected.', 'info');
    });

    function loadPendingDeliveries() {
      try {
        const stored = localStorage.getItem('pendingDeliveries');
        if (stored) {
          pendingDeliveries = JSON.parse(stored);
        }
      } catch (e) {
        console.error('Error loading pending deliveries:', e);
      }
    }

    function savePendingDeliveries() {
      try {
        localStorage.setItem('pendingDeliveries', JSON.stringify(pendingDeliveries));
      } catch (e) {
        console.error('Error saving pending deliveries:', e);
      }
    }

    async function syncPendingDeliveries() {
      if (pendingDeliveries.length === 0 || !isOnline) return;

      showLoading('Syncing offline deliveries...');

      for (let i = pendingDeliveries.length - 1; i >= 0; i--) {
        const delivery = pendingDeliveries[i];
        try {
          // Upload photo from base64
          const photoBlob = await fetch(delivery.photoData).then(r => r.blob());
          const fileName = `delivery_${delivery.assetId}_${Date.now()}.jpg`;
          const filePath = `deliveries/${fileName}`;

          await supabase.storage.from('ticket-photos').upload(filePath, photoBlob);
          const { data: urlData } = supabase.storage.from('ticket-photos').getPublicUrl(filePath);

          // Update asset
          await supabase.from('assets').update({
            supply_date: delivery.timestamp,
            last_checkin_date: delivery.timestamp,
            gps: delivery.gps,
            photo: [urlData.publicUrl],
            name: delivery.recipientName || undefined,
            notes: delivery.notes || undefined
          }).eq('unique_id', delivery.assetId);

          // Create checkin
          await supabase.from('checkins').insert({
            asset_id: delivery.assetId,
            visitor_name: delivery.recipientName || 'Delivery Driver',
            status: 'Good',
            comments: `Delivered (synced). GPS: ${delivery.gps}`,
            photo_url: urlData.publicUrl
          });

          // Remove from pending
          pendingDeliveries.splice(i, 1);
          savePendingDeliveries();

        } catch (error) {
          console.error('Error syncing delivery:', error);
        }
      }

      hideLoading();
      loadTodayDeliveries();
      showMessage(`Synced ${pendingDeliveries.length === 0 ? 'all' : 'some'} offline deliveries`, 'success');
    }

    // ============================================================================
    // QR SCANNER - Using html5-qrcode with proper initialization
    // ============================================================================

    document.getElementById('scanBtn').addEventListener('click', startScanner);
    document.getElementById('stopScanBtn').addEventListener('click', stopScanner);

    async function startScanner() {
      scannerSection.classList.add('show');

      try {
        html5QrCode = new Html5Qrcode("qr-reader");

        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        };

        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanFailure
        );
      } catch (err) {
        console.error("Error starting scanner:", err);
        showMessage('Could not access camera: ' + err.message, 'error');
        stopScanner();
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      // Extract asset ID from QR code URL or direct ID
      let assetId = decodedText;

      // Handle URL format: https://domain.com/?asset_id=GB0-152-1
      if (decodedText.includes('asset_id=')) {
        try {
          const url = new URL(decodedText);
          assetId = url.searchParams.get('asset_id');
        } catch (e) {
          // Try regex extraction if URL parsing fails
          const match = decodedText.match(/asset_id=([^&]+)/);
          if (match) assetId = match[1];
        }
      }
      // Handle direct ID format
      else if (decodedText.match(/GB0-\d+(-\d+)?/)) {
        assetId = decodedText.match(/GB0-\d+(-\d+)?/)[0];
      }

      if (assetId) {
        stopScanner();
        assetSearch.value = assetId.toUpperCase();
        searchAsset(assetId.toUpperCase());
      }
    }

    function onScanFailure(error) {
      // Ignore - continuous scanning
    }

    function stopScanner() {
      scannerSection.classList.remove('show');
      if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
        }).catch(err => console.log("Scanner stop error:", err));
      }
    }

    // ============================================================================
    // ASSET SEARCH
    // ============================================================================

    assetSearch.addEventListener('keyup', async (e) => {
      if (e.key === 'Enter') {
        await searchAsset(assetSearch.value.trim().toUpperCase());
      }
    });

    assetSearch.addEventListener('blur', async () => {
      const value = assetSearch.value.trim().toUpperCase();
      if (value && value !== currentAsset?.unique_id) {
        await searchAsset(value);
      }
    });

    // Check URL for asset_id parameter
    const urlParams = new URLSearchParams(window.location.search);
    const urlAssetId = urlParams.get('asset_id');
    if (urlAssetId) {
      assetSearch.value = urlAssetId;
      searchAsset(urlAssetId);
    }

    async function searchAsset(assetId) {
      if (!assetId) return;

      showLoading('Loading asset...');

      try {
        const { data, error } = await supabase
          .from('assets')
          .select('*')
          .eq('unique_id', assetId)
          .single();

        if (error) throw error;

        if (data) {
          currentAsset = data;
          displayAsset(data);
        } else {
          showMessage('Asset not found: ' + assetId, 'error');
          hideAssetCard();
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('Asset not found. Check the ID and try again.', 'error');
        hideAssetCard();
      } finally {
        hideLoading();
      }
    }

    function displayAsset(asset) {
      document.getElementById('assetIdDisplay').textContent = asset.unique_id;
      document.getElementById('assetTypeDisplay').textContent = asset.product || 'Asset';
      document.getElementById('recipientDisplay').textContent = asset.name || '-';
      document.getElementById('communityDisplay').textContent = asset.community || '-';
      document.getElementById('placeDisplay').textContent = asset.place || '-';

      // Check if already delivered today
      const isDelivered = asset.supply_date &&
        new Date(asset.supply_date).toDateString() === new Date().toDateString();
      document.getElementById('statusDisplay').textContent =
        isDelivered ? '‚úÖ Delivered Today' : (asset.supply_date ? 'üì¶ Previously Delivered' : '‚è≥ Not Delivered');

      assetCard.classList.add('show');
      deliveryForm.classList.add('show');
      submitSection.classList.add('show');

      // Pre-fill recipient if available
      if (asset.name) {
        document.getElementById('recipientInput').value = asset.name;
      }
    }

    function hideAssetCard() {
      currentAsset = null;
      assetCard.classList.remove('show');
      deliveryForm.classList.remove('show');
      submitSection.classList.remove('show');
    }

    // ============================================================================
    // PHOTO CAPTURE + COMPRESSION
    // ============================================================================

    photoCapture.addEventListener('click', () => {
      photoInput.click();
    });

    photoInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        capturedPhoto = file;

        // Show original
        const reader = new FileReader();
        reader.onload = async (e) => {
          photoPreview.src = e.target.result;
          photoPreview.style.display = 'block';
          photoPlaceholder.style.display = 'none';
          photoCapture.classList.add('has-photo');

          // Compress the image
          photoSize.textContent = `Original: ${(file.size / 1024).toFixed(0)} KB - Compressing...`;
          compressedPhotoBlob = await compressImage(file);
          photoSize.textContent = `Compressed: ${(compressedPhotoBlob.size / 1024).toFixed(0)} KB (was ${(file.size / 1024).toFixed(0)} KB)`;
        };
        reader.readAsDataURL(file);
      }
    });

    async function compressImage(file, maxWidth = 1200, quality = 0.7) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Scale down if needed
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
              resolve(blob);
            }, 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // ============================================================================
    // GPS LOCATION
    // ============================================================================

    locationBtn.addEventListener('click', captureLocation);

    function captureLocation() {
      if (!navigator.geolocation) {
        showMessage('GPS not supported on this device', 'error');
        return;
      }

      locationIcon.classList.add('loading');
      locationIcon.textContent = '...';
      locationValue.textContent = 'Getting location...';

      navigator.geolocation.getCurrentPosition(
        (position) => {
          capturedLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy
          };

          locationIcon.classList.remove('loading');
          locationIcon.classList.add('success');
          locationIcon.textContent = '‚úì';
          locationValue.textContent = `${capturedLocation.lat.toFixed(6)}, ${capturedLocation.lng.toFixed(6)}`;
          locationBtn.textContent = 'Refresh Location';
          locationBtn.style.display = 'block';
        },
        (error) => {
          console.error('GPS Error:', error);
          locationIcon.classList.remove('loading');
          locationIcon.textContent = '‚ùå';
          locationValue.textContent = 'Could not get location';
          locationBtn.textContent = 'Try Again';
          locationBtn.style.display = 'block';
          showMessage('Enable location in your browser settings', 'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    }

    // ============================================================================
    // SUBMIT DELIVERY
    // ============================================================================

    submitBtn.addEventListener('click', async () => {
      if (!currentAsset) {
        showMessage('Please select an asset first', 'error');
        return;
      }

      if (!compressedPhotoBlob && !capturedPhoto) {
        showMessage('Please take a photo of the delivery', 'error');
        return;
      }

      if (!capturedLocation) {
        showMessage('Please wait for GPS location', 'error');
        return;
      }

      // Offline mode - save locally
      if (!isOnline) {
        await saveOfflineDelivery();
        return;
      }

      showLoading('Uploading photo...');

      try {
        // 1. Upload compressed photo
        const photoToUpload = compressedPhotoBlob || capturedPhoto;
        const fileName = `delivery_${currentAsset.unique_id}_${Date.now()}.jpg`;
        const filePath = `deliveries/${fileName}`;

        const { error: uploadError } = await supabase.storage
          .from('ticket-photos')
          .upload(filePath, photoToUpload);

        if (uploadError) throw uploadError;

        // Get public URL
        const { data: urlData } = supabase.storage
          .from('ticket-photos')
          .getPublicUrl(filePath);

        const photoUrl = urlData.publicUrl;

        // 2. Update asset with delivery info
        document.getElementById('loadingText').textContent = 'Saving delivery...';

        const gpsString = `${capturedLocation.lat},${capturedLocation.lng}`;
        const notes = document.getElementById('notesInput').value.trim();
        const recipientName = document.getElementById('recipientInput').value.trim();

        const updateData = {
          supply_date: new Date().toISOString(),
          last_checkin_date: new Date().toISOString(),
          gps: gpsString,
          photo: currentAsset.photo ? [...currentAsset.photo, photoUrl] : [photoUrl]
        };

        if (recipientName) {
          updateData.name = recipientName;
        }

        if (notes) {
          updateData.notes = currentAsset.notes
            ? `${currentAsset.notes}\n[Delivery ${new Date().toLocaleDateString()}]: ${notes}`
            : `[Delivery ${new Date().toLocaleDateString()}]: ${notes}`;
        }

        const { error: updateError } = await supabase
          .from('assets')
          .update(updateData)
          .eq('unique_id', currentAsset.unique_id);

        if (updateError) throw updateError;

        // 3. Create a check-in record
        await supabase
          .from('checkins')
          .insert({
            asset_id: currentAsset.unique_id,
            visitor_name: recipientName || 'Delivery Driver',
            status: 'Good',
            comments: `Delivered. GPS: ${gpsString}${notes ? '. Notes: ' + notes : ''}`,
            photo_url: photoUrl
          });

        // 4. Show success
        hideLoading();
        showSuccess();

      } catch (error) {
        console.error('Error:', error);
        hideLoading();
        showMessage('Failed to save delivery: ' + error.message, 'error');
      }
    });

    async function saveOfflineDelivery() {
      // Convert photo to base64 for local storage
      const reader = new FileReader();
      reader.onload = () => {
        const delivery = {
          assetId: currentAsset.unique_id,
          timestamp: new Date().toISOString(),
          gps: `${capturedLocation.lat},${capturedLocation.lng}`,
          recipientName: document.getElementById('recipientInput').value.trim(),
          notes: document.getElementById('notesInput').value.trim(),
          photoData: reader.result
        };

        pendingDeliveries.push(delivery);
        savePendingDeliveries();

        // Add to today's deliveries display
        todayDeliveries.unshift({
          id: currentAsset.unique_id,
          time: new Date(),
          pending: true
        });
        updateRecentDeliveries();

        showSuccess();
      };
      reader.readAsDataURL(compressedPhotoBlob || capturedPhoto);
    }

    // ============================================================================
    // SUCCESS & RESET
    // ============================================================================

    function showSuccess() {
      document.getElementById('successAssetId').textContent = currentAsset.unique_id;
      document.getElementById('successTime').textContent = new Date().toLocaleTimeString();
      document.getElementById('successLocation').textContent =
        capturedLocation ? `${capturedLocation.lat.toFixed(4)}, ${capturedLocation.lng.toFixed(4)}` : 'Captured';

      // Add to today's deliveries if not already added (online mode)
      if (!todayDeliveries.find(d => d.id === currentAsset.unique_id)) {
        todayDeliveries.unshift({
          id: currentAsset.unique_id,
          time: new Date()
        });
      }
      updateRecentDeliveries();

      successScreen.classList.add('show');
    }

    document.getElementById('nextBtn').addEventListener('click', () => {
      resetForm();
      successScreen.classList.remove('show');
      assetSearch.value = '';
      assetSearch.focus();

      // Re-capture GPS for next delivery
      captureLocation();
    });

    function resetForm() {
      currentAsset = null;
      capturedPhoto = null;
      compressedPhotoBlob = null;

      hideAssetCard();

      // Reset photo
      photoInput.value = '';
      photoPreview.src = '';
      photoPreview.style.display = 'none';
      photoPlaceholder.style.display = 'block';
      photoCapture.classList.remove('has-photo');
      photoSize.textContent = '';

      // Reset inputs
      document.getElementById('recipientInput').value = '';
      document.getElementById('notesInput').value = '';
    }

    function updateRecentDeliveries() {
      const container = document.getElementById('recentDeliveries');
      const countEl = document.getElementById('deliveryCount');

      countEl.textContent = todayDeliveries.length;

      if (todayDeliveries.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <div class="empty-text">No deliveries yet today</div>
          </div>
        `;
        return;
      }

      container.innerHTML = todayDeliveries.map(d => `
        <div class="recent-item">
          <div class="recent-check ${d.pending ? 'recent-pending' : ''}">
            ${d.pending ? '‚è≥' : '‚úì'}
          </div>
          <div class="recent-info">
            <div class="recent-id">${d.id}</div>
            <div class="recent-time">${d.time.toLocaleTimeString()}${d.pending ? ' (pending sync)' : ''}</div>
          </div>
        </div>
      `).join('');
    }

    // ============================================================================
    // HELPERS
    // ============================================================================

    function showMessage(text, type) {
      messageBox.textContent = text;
      messageBox.className = `message ${type} show`;
      setTimeout(() => {
        messageBox.classList.remove('show');
      }, 4000);
    }

    function showLoading(text) {
      document.getElementById('loadingText').textContent = text || 'Loading...';
      loadingOverlay.classList.add('show');
    }

    function hideLoading() {
      loadingOverlay.classList.remove('show');
    }

    // ============================================================================
    // LOAD TODAY'S DELIVERIES ON START
    // ============================================================================

    async function loadTodayDeliveries() {
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const { data, error } = await supabase
          .from('assets')
          .select('unique_id, supply_date')
          .gte('supply_date', today.toISOString())
          .order('supply_date', { ascending: false })
          .limit(20);

        if (data) {
          todayDeliveries = data.map(d => ({
            id: d.unique_id,
            time: new Date(d.supply_date)
          }));

          // Add pending deliveries
          pendingDeliveries.forEach(p => {
            if (!todayDeliveries.find(d => d.id === p.assetId)) {
              todayDeliveries.push({
                id: p.assetId,
                time: new Date(p.timestamp),
                pending: true
              });
            }
          });

          // Sort by time
          todayDeliveries.sort((a, b) => b.time - a.time);

          updateRecentDeliveries();
        }
      } catch (error) {
        console.error('Error loading today deliveries:', error);
      }
    }

    // ============================================================================
    // INITIALIZE
    // ============================================================================

    // Load pending deliveries from localStorage
    loadPendingDeliveries();

    // Load today's deliveries from server
    loadTodayDeliveries();

    // Auto-capture GPS on page load
    captureLocation();

    // Check online status
    if (!navigator.onLine) {
      isOnline = false;
      offlineBadge.classList.add('show');
    }

    // Sync any pending deliveries if online
    if (isOnline && pendingDeliveries.length > 0) {
      setTimeout(syncPendingDeliveries, 2000);
    }
  </script>
</body>
</html>
