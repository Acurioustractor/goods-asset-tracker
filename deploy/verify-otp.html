<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Enter Code - Goods on Country</title>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f172a;
      min-height: 100vh;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 400px;
    }

    .card {
      background: #1e293b;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      padding: 32px 24px;
      text-align: center;
    }

    .header-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .phone-display {
      background: rgba(255, 255, 255, 0.15);
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 8px;
    }

    .content {
      padding: 32px 24px;
    }

    .otp-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 24px;
    }

    .otp-input {
      width: 48px;
      height: 60px;
      background: #0f172a;
      border: 2px solid #334155;
      border-radius: 12px;
      color: white;
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      transition: border-color 0.2s;
    }

    .otp-input:focus {
      outline: none;
      border-color: #10b981;
    }

    .otp-input.filled {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    .otp-input.error {
      border-color: #ef4444;
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }

    .submit-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .resend-section {
      text-align: center;
      margin-top: 24px;
    }

    .resend-text {
      color: #64748b;
      font-size: 14px;
    }

    .resend-btn {
      background: none;
      border: none;
      color: #3b82f6;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 16px;
      margin-top: 4px;
    }

    .resend-btn:disabled {
      color: #64748b;
      cursor: not-allowed;
    }

    .resend-btn:hover:not(:disabled) {
      text-decoration: underline;
    }

    .countdown {
      color: #64748b;
      font-size: 13px;
    }

    .message {
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .message.success {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #6ee7b7;
    }

    .back-link {
      display: block;
      text-align: center;
      color: #64748b;
      text-decoration: none;
      font-size: 14px;
      margin-top: 20px;
    }

    .back-link:hover {
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="header-icon">üì±</div>
        <h1>Enter Code</h1>
        <p>We sent a 6-digit code to</p>
        <div class="phone-display" id="phoneDisplay">+61 *** *** ***</div>
      </div>

      <div class="content">
        <div id="messageBox" class="message"></div>

        <form id="verifyForm">
          <div class="otp-container">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5">
          </div>

          <button type="submit" id="submitBtn" class="submit-btn">
            <span id="btnText">Verify</span>
          </button>
        </form>

        <div class="resend-section">
          <p class="resend-text">Didn't receive the code?</p>
          <button id="resendBtn" class="resend-btn" disabled>
            Resend Code <span id="countdown" class="countdown">(60s)</span>
          </button>
        </div>

        <a href="login.html" class="back-link">
          ‚Üê Use a different number
        </a>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const SUPABASE_URL = 'https://cwsyhpiuepvdjtxaozwf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3c3locGl1ZXB2ZGp0eGFvendmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NTcxODgsImV4cCI6MjA4MDIzMzE4OH0.Pgexh-ff_zU4SsDWV3uGO7foQjCO8xZbWvN_BU6Vxkw';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================================================
    // STATE
    // ============================================================================
    const phone = sessionStorage.getItem('verify_phone');
    const claimAsset = sessionStorage.getItem('claim_asset');
    let countdownTimer = null;
    let secondsLeft = 60;

    // If no phone stored, redirect back to login
    if (!phone) {
      window.location.href = 'login.html';
    }

    // ============================================================================
    // DOM ELEMENTS
    // ============================================================================
    const form = document.getElementById('verifyForm');
    const otpInputs = document.querySelectorAll('.otp-input');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const messageBox = document.getElementById('messageBox');
    const resendBtn = document.getElementById('resendBtn');
    const countdownEl = document.getElementById('countdown');
    const phoneDisplay = document.getElementById('phoneDisplay');

    // Show masked phone
    if (phone) {
      const masked = phone.substring(0, 4) + ' *** *** ' + phone.substring(phone.length - 3);
      phoneDisplay.textContent = masked;
    }

    // ============================================================================
    // OTP INPUT HANDLING
    // ============================================================================
    otpInputs.forEach((input, index) => {
      // Auto-focus next input
      input.addEventListener('input', (e) => {
        const value = e.target.value;

        // Only allow digits
        if (!/^\d*$/.test(value)) {
          e.target.value = '';
          return;
        }

        if (value) {
          input.classList.add('filled');

          // Move to next input
          if (index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        } else {
          input.classList.remove('filled');
        }

        // Auto-submit when all filled
        const code = getOTP();
        if (code.length === 6) {
          submitForm();
        }
      });

      // Handle backspace
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !input.value && index > 0) {
          otpInputs[index - 1].focus();
        }
      });

      // Handle paste
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const digits = paste.replace(/\D/g, '').substring(0, 6);

        digits.split('').forEach((digit, i) => {
          if (otpInputs[i]) {
            otpInputs[i].value = digit;
            otpInputs[i].classList.add('filled');
          }
        });

        // Focus last filled or next empty
        const nextIndex = Math.min(digits.length, otpInputs.length - 1);
        otpInputs[nextIndex].focus();

        if (digits.length === 6) {
          submitForm();
        }
      });
    });

    // Focus first input on load
    otpInputs[0].focus();

    // ============================================================================
    // FORM SUBMISSION
    // ============================================================================
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      submitForm();
    });

    async function submitForm() {
      const code = getOTP();

      if (code.length !== 6) {
        showMessage('Please enter the 6-digit code', 'error');
        return;
      }

      submitBtn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span>';

      try {
        const { data, error } = await supabase.auth.verifyOtp({
          phone: phone,
          token: code,
          type: 'sms'
        });

        if (error) throw error;

        // Success! Clear session storage
        sessionStorage.removeItem('verify_phone');

        showMessage('Verified! Redirecting...', 'success');

        // If there's an asset to claim, redirect with claim param
        if (claimAsset) {
          sessionStorage.removeItem('claim_asset');
          window.location.href = `my-items.html?claim=${claimAsset}`;
        } else {
          window.location.href = 'my-items.html';
        }

      } catch (error) {
        console.error('Error:', error);

        // Show error on inputs
        otpInputs.forEach(input => input.classList.add('error'));
        setTimeout(() => {
          otpInputs.forEach(input => input.classList.remove('error'));
        }, 500);

        if (error.message.includes('expired')) {
          showMessage('Code expired. Please request a new one.', 'error');
        } else if (error.message.includes('invalid')) {
          showMessage('Invalid code. Please try again.', 'error');
        } else {
          showMessage('Error: ' + error.message, 'error');
        }

        submitBtn.disabled = false;
        btnText.textContent = 'Verify';

        // Clear inputs
        otpInputs.forEach(input => {
          input.value = '';
          input.classList.remove('filled');
        });
        otpInputs[0].focus();
      }
    }

    // ============================================================================
    // RESEND CODE
    // ============================================================================
    startCountdown();

    resendBtn.addEventListener('click', async () => {
      resendBtn.disabled = true;

      try {
        const { error } = await supabase.auth.signInWithOtp({
          phone: phone,
          options: { channel: 'sms' }
        });

        if (error) throw error;

        showMessage('New code sent!', 'success');
        startCountdown();

      } catch (error) {
        console.error('Resend error:', error);
        showMessage('Error sending code: ' + error.message, 'error');
        resendBtn.disabled = false;
      }
    });

    function startCountdown() {
      secondsLeft = 60;
      resendBtn.disabled = true;
      countdownEl.textContent = `(${secondsLeft}s)`;

      countdownTimer = setInterval(() => {
        secondsLeft--;
        countdownEl.textContent = `(${secondsLeft}s)`;

        if (secondsLeft <= 0) {
          clearInterval(countdownTimer);
          resendBtn.disabled = false;
          countdownEl.textContent = '';
        }
      }, 1000);
    }

    // ============================================================================
    // HELPERS
    // ============================================================================
    function getOTP() {
      return Array.from(otpInputs).map(input => input.value).join('');
    }

    function showMessage(text, type) {
      messageBox.textContent = text;
      messageBox.className = `message ${type} show`;
    }
  </script>
</body>
</html>
